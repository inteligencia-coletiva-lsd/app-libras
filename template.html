<script type="text/javascript" src="http://malsup.github.com/jquery.blockUI.js"></script>

<div class="row">
    <!-- Success and Error Messages for the user -->
    <div class="span6 offset2" style="height:50px">
        <div id="success" class="alert alert-success" style="display:none;">
            <a class="close">×</a>
            <strong>Well done!</strong> Your answer has been saved
        </div>
        <div id="loading" class="alert alert-info" style="display:none;">
            <a class="close">×</a>
            Loading next task...
        </div>
        <div id="taskcompleted" class="alert alert-info" style="display:none;">
            <strong>The task has been completed!</strong> Thanks a lot!
        </div>
        <div id="finish" class="alert alert-success" style="display:none;">
            <strong>Congratulations!</strong> You have participated in all available tasks!
            <br/>
            <div class="alert-actions">
                <a class="btn small" href="/">Go back</a>
                <a class="btn small" href="/app">or, Check other applications</a>
            </div>
        </div>
        <div id="error" class="alert alert-error" style="display:none;">
            <a class="close">×</a>
            <strong>Error!</strong> Something went wrong, please contact the site administrators
        </div>
    </div> <!-- End Success and Error Messages for the user -->
</div> <!-- End of Row -->

<!--
    Task DOM for loading the Flickr Images
    It uses the class="skeleton" to identify the elements that belong to the
    task.
-->
<div class="skeleton" style="margin-top: 30px; margin-bottom: 30px"> <!-- Start Skeleton -->
    <h1 id="question"></h1> <!-- The question will be loaded here -->
</div><!-- End of Skeleton -->

<div class="skeleton"> <!-- Start Skeleton -->

   <div id="parametros_sinal" style="float: left; width:400px; height: 450px;">
    <div id="quantidade_maos" style="display: none;">
        <button class="btn btn-large btn-info btn-answer" style="width: 130px; display: block;" value='uma'>
            Uma m&atilde;o
        </button>
        <button class="btn btn-large btn-info btn-answer" style="width: 130px; display: block; margin: 10px auto 0 0;" value='duas'>
	    Duas m&atilde;os
        </button>
    </div>

    <div id="orientacao_palma_da_mao" style="display: none; float: left;">
        <!-- Ori 1 -->
        <div class="palma_image" style="margin: 0px 0 0 5px; float: left;">
            <button class="btn btn-answer" type="button" value="Ori_1">
                <img src="http://bit.ly/166zJWo" width="82px" height="106px"/>
            </button>
        </div>
        <!-- Ori 2 -->
        <div class="palma_image"style="margin: 0px 0 0 5px; float: left;">
            <button class="btn btn-answer" type="button" value="Ori_2">
                <img src="http://bit.ly/10IL8Zp" width="82px" height="106px"/>
            </button>   
        </div>
        <!-- Ori 3 -->
        <div class="palma_image" style="margin: 0px 0 0 5px; float: left;">
            <button class="btn btn-answer" type="button" value="Ori_3">
                <img src="http://bit.ly/11yVCw2" width="82px" height="106px"/>
            </button>
        </div>
        <!-- Ori 4 -->
        <div class="palma_image" style="margin: 0px  0px 0px 5px; float: left;">
            <button class="btn btn-answer" type="button" value="Ori_4">
                <img src="http://bit.ly/10o8PEB" width="82px" height="106px"/>
            </button>
        </div>
        <!-- Ori 5 -->
        <div class="palma_image" style="margin: 0px 0 0 5px; float: left;">
            <button class="btn btn-answer" type="button" value="Ori_5">
                <img src="http://bit.ly/15G9cPA"  width="82px" height="106px"/>
            </button>
        </div>
        <!-- Ori 6 -->
        <div class="palma_image" style="margin: 0px 0 0 5px; float: left;">
            <button class="btn btn-answer" type="button" value="Ori_6">
                <img src="http://bit.ly/14hLm8f" width="82px" height="106px"/>
            </button> 
        </div>
        <!-- Ori 7 -->
        <div class="palma_image" style="margin: 0px 0 0 5px; float: left;">
            <button class="btn btn-answer" type="button" value="Ori_7">
                <img src="http://bit.ly/YFbHMK" width="82px" height="106px"/>
            </button>
        </div>
        <!-- Ori 8 -->
        <div class="palma_image" style="margin: 0px 0px 0px 5px; float: left;">
            <button class="btn btn-answer" type="button" value="Ori_8">
                <img src="http://bit.ly/YFbxF3" width="82px" height="106px"/>
            </button>
        </div>
        <!-- Ori 9 -->
        <div class="palma_image" style="margin: 0px 0px 0px 5px; float: left;">
            <button class="btn btn-answer" type="button" value="Ori_9">
                <img src="http://bit.ly/11yVwo9" width="82px" height="106px"/>
            </button>
        </div>
        <!-- Ori 10 --> 
        <div class="palma_image" style="margin: 0px 0px 0px 5px; float: left;">
            <button class="btn btn-answer" type="button" value="Ori_10">
                <img src="http://bit.ly/10EeUtF"  width="82px" height="106px"/>
            </button>
        </div>
        <!-- Ori 11 -->
        <div class="palma_image" style="margin: 0px 0px 0px 5px; float: left">
            <button class="btn btn-answer" type="button" value="Ori_11">
                <img src="http://bit.ly/18G71uf" width="82px" height="106px"/>
            </button>
        </div>
        <!-- Ori 12 --> 
        <div class="palma_image" style="margin: 0px 0 0 5px; float: left">
            <button class="btn btn-answer" type="button" value="Ori_12">
                <img src="http://bit.ly/13n6Ql3"  width="82px" height="106px"/>
            </button>
        </div>
    </div><!-- End of orientacao_palma_da_mao -->
    <!-- Begin of expressao_facial -->
    <section id="expressao_facial" style="display: none; float: left;">
      <div class="pagination expressao_pagination" style="padding: 0; margin: 0 5px 0 0; width: 100%;">
        <ul style="padding: 0; margin-left: 20%">
          <li data-exp_group="prev"><a href="#">Prev</a></li>
          <li data-exp_group="group_1"><a href="#">1</a></li>
          <li data-exp_group="group_2"><a href="#">2</a></li>
          <li data-exp_group="group_3"><a href="#">3</a></li>
          <li data-exp_group="next"><a href="#">Next</a></li>
        </ul>
      </div>
      <div style="padding: 0; margin-left: 11%">
        <li class="exp" title=""  data-exp_facial="" ></li>
        <li class="exp" title=""  data-exp_facial="" ></li>
        <li class="exp" title=""  data-exp_facial="" ></li>
        <li class="exp" title=""  data-exp_facial="" ></li>
        <li class="exp" title=""  data-exp_facial="" ></li>
        <li class="exp" title=""  data-exp_facial="" ></li>
      </div>
    </section> <!-- End of expressao_facial -->
    <!--Begin of ponto_de_articulacao -->
    <div id="ponto_de_articulacao" style="display: none; float: left;">
        <map name="avatar_completo" id="avatar_completo">   
          <!-- Cabeca -->
          <area title="topo da cabeca"    shape="rect" coords="105, 0, 215, 25"    href="#"  data-local="Pa_63" />
          <area title="testa"             shape="rect" coords="105, 30, 215, 55"   href="#"  data-local="Pa_60" />
          <area title="olho direito"      shape="rect" coords="125, 65, 155, 90"   href="#"  data-local="Pa_35" />
          <area title="olho esquerdo"     shape="rect" coords="170, 65, 200, 90"   href="#"  data-local="Pa_38" />
          <area title="nariz"             shape="rect" coords="145, 85, 175, 105"  href="#"  data-local="Pa_32" />
          <area title="boca"              shape="rect" coords="145, 110, 175, 130" href="#"  data-local="Pa_6"  />
          <area title="queixo"            shape="rect" coords="145, 130, 175, 150" href="#"  data-local="Pa_57" />
          <area title="pescoco"           shape="rect" coords="145, 155, 175, 175" href="#"  data-local="Pa_56" />
          <area title="bochecha direita"  shape="rect" coords="115, 100, 145, 120" href="#"  data-local="Pa_9R"  />
          <area title="bochecha esquerda" shape="rect" coords="180, 100, 210, 120" href="#"  data-local="Pa_9L"  />
          <area title="orelha direita"    shape="rect" coords="90, 70, 120, 95"    href="#"  data-local="Pa_50" />
          <area title="orelha esquerda"   shape="rect" coords="200, 70, 230, 95"   href="#"  data-local="Pa_53" />
          
          <!-- Tronco -->
          <area title="ombro centro"     shape="rect" coords="145, 190, 160, 215" href="#"  data-local="Pa_41" /> 
          <area title="ombro direito"    shape="rect" coords="55, 190, 80, 215"   href="#"  data-local="Pa_44" />
          <area title="ombro esquerdo"   shape="rect" coords="240, 190, 265, 215" href="#"  data-local="Pa_47" />
          <area title="busto centro"     shape="rect" coords="145, 260, 160, 285" href="#"  data-local="Pa_12" />
          <area title="busto direito"    shape="rect" coords="85, 260, 110, 285"  href="#"  data-local="Pa_15" />
          <area title="busto esquerdo"   shape="rect" coords="210, 260, 235, 285" href="#"  data-local="Pa_18" />
          <area title="estomago"         shape="rect" coords="150, 350, 175, 375" href="#"  data-local="Pa_21" />
          <area title="umbigo"           shape="rect" coords="150, 415, 175, 440" href="#"  data-local="Pa_66" />
          <area title="cintura direita"  shape="rect" coords="80, 415, 105, 440"  href="#"  data-local="Pa_24" />
          <area title="cintura esquerda" shape="rect" coords="215, 415, 240, 440" href="#"  data-local="Pa_27" />
        </map>

        <map name="avatar_distancia" id="avatar_distancia">
          <area title="pequena" shape="rect" coords="65, 205, 115, 255"  href="#"  data-local="0" />
          <area title="media"   shape="rect" coords="145, 205, 195, 255" href="#"  data-local="1" />
          <area title="grande"  shape="rect" coords="240, 205, 290, 255" href="#"  data-local="2" />
        </map>
        
        <img id="avatar_completo_img"  src="http://bit.ly/10lA9nE" style="margin: 2px 0 0 2px" usemap="#avatar_completo" />
        <img id="avatar_distancia_img" src="http://bit.ly/10Y64tS" style="margin: 2px 0 0 2px; display: none" usemap="#avatar_distancia" />
    </div><!-- End of ponto_de_articulacao -->
    <!-- Begin of tipos_de_mao -->
    <section id="tipos_de_mao" style="display: none;">
      <div class="pagination pagination-right handshape_pagination" style="padding: 0; margin: 0 5px 0 0; width: 100%; float: right;">
        <ul style="padding: 0; margin: 0 0 0 0px">
          <li data-handshape_group="prev"><a href="#">Prev</a></li>
          <li data-handshape_group="group_1"><a href="#">1</a></li>
          <li data-handshape_group="group_2"><a href="#">2</a></li>
          <li data-handshape_group="next"><a href="#">Next</a></li>
        </ul>
      </div>
      <div id="maos">
        <li class="handshape" data-handshape="conf_1"></li>
        <li class="handshape" data-handshape="conf_2"></li>
        <li class="handshape" data-handshape="conf_3"></li>
        <li class="handshape" data-handshape="conf_4"></li>
        <li class="handshape" data-handshape="conf_5"></li>
        <li class="handshape" data-handshape="conf_6"></li>
        <li class="handshape" data-handshape="conf_7"></li>
        <li class="handshape" data-handshape="conf_8"></li>
        <li class="handshape" data-handshape="conf_9"></li>
        <li class="handshape" data-handshape="conf_10"></li>
        <li class="handshape" data-handshape="conf_11"></li>
        <li class="handshape" data-handshape="conf_12"></li>
        <li class="handshape" data-handshape="conf_13"></li>
        <li class="handshape" data-handshape="conf_14"></li>
        <li class="handshape" data-handshape="conf_15"></li>
        <li class="handshape" data-handshape="conf_16"></li>
        <li class="handshape" data-handshape="conf_17"></li>
        <li class="handshape" data-handshape="conf_18"></li>
        <li class="handshape" data-handshape="conf_19"></li>
        <li class="handshape" data-handshape="conf_20"></li>
        <li class="handshape" data-handshape="conf_21"></li>
        <li class="handshape" data-handshape="conf_22"></li>
        <li class="handshape" data-handshape="conf_23"></li>
        <li class="handshape" data-handshape="conf_24"></li>
        <li class="handshape" data-handshape="conf_25"></li>
        <li class="handshape" data-handshape="conf_26"></li>
        <li class="handshape" data-handshape="conf_27"></li>
        <li class="handshape" data-handshape="conf_28"></li>
        <li class="handshape" data-handshape="conf_29"></li>
        <li class="handshape" data-handshape="conf_30"></li>
      </div>
    </section> <!-- End of tipos_de_mao -->

    <div id="report-pane" style="float: left; display: none;">
      <div id="render_progress" class="progress progress-striped active" style="display: none; height: 30px; width: 300px; margin-top: 200px; margin-left: 50px; position: absolute; z-index: 1;"></div>
      <div id="confirmacao_avatar" style="display: none; margin: 0 50px 10px 50px;"> 
        <button class="btn btn-large btn-success btn-answer" style="width: 130px; float: left;" value='Sim'>
            Confirmar
        </button>
        <button class="btn btn-large btn-danger btn-answer" style="width: 130px; margin-left: 30px;"  value='Nao'>
            Corrigir
        </button>
      </div>
      <div id="avatar_video" style="display: none;"></div>
    </div> <!-- End of report-pane div -->

    <div id="correcao" style="float: left; display: none;">
      <div id="mao_direita" style="display: block;"><h1>M&atilde;o Direita</h1>
        <div id="parametros_dir" style="height: 80px; margin-bottom: 30px;"></div>
      </div>
      <div id="mao_esquerda" style="display: block;">
	<div id="header_mao_esquerda" style="margin-bottom: 10px">
		<h1 style="float: left">M&atilde;o Esquerda</h1>
		<div id="adicionar_remover_mao" style="display: inline; margin-left: 20px"> 
			<button id="remover_mao" class="btn btn-large btn-info add-remove" style="width: 100px;" value='Remover'>
			    Remover
			</button>
			<button id="adicionar_mao" class="btn btn-large btn-info add-remove" style="width: 100px;"  value='Adicionar'>
			    Adicionar
			</button>
		</div>
	</div>
	<div id="parametros_esq" style="height: 80px; margin-bottom: 30px; display: none;"></div>
      </div>
      <div id="parametro_exp_facial" style="display: block; margin-top: 25px; height: 190px"></div>
      <button id="render" class="btn btn-large btn-success btn-answer" style="width: 130px;" value='Render'>
	  Gerar Avatar
      </button>
    </div> <!-- End of correcao div -->

   </div> <!-- Parametros do sinal -->

   <div id="signal_video" style="float: right; width: 540px; height: 450px;"></div><!-- The video will be showed here -->
</div><!-- End of Skeleton -->

<div class="row skeleton">
    <div style="margin-top: 30px; margin-bottom: 30px; float: right;">
        <div id="pular_tarefa">
	   <button class="btn btn-large btn-warning" style="margin: 0 0 0 5px; width: 130px; float: right;" value='Pular'>
	       Pular sinal
	   </button>
        </div> <!-- Pular tarefa -->
    </div>
</div>

<script>

pybossa.taskLoaded(function(task, deferred) {
    deferred.resolve(task);
});

pybossa.presentTask(function(task, deferred) {

    var orient2sprite = { "Ori_1": "http://bit.ly/166zJWo",
		       "Ori_2": "http://bit.ly/10IL8Zp",
		       "Ori_3": "http://bit.ly/11yVCw2",
   		       "Ori_4": "http://bit.ly/10o8PEB",
 		       "Ori_5": "http://bit.ly/15G9cPA",
		       "Ori_6": "http://bit.ly/14hLm8f",
		       "Ori_7": "http://bit.ly/YFbHMK",
		       "Ori_8": "http://bit.ly/YFbxF3",
		       "Ori_9": "http://bit.ly/11yVwo9",
		       "Ori_10": "http://bit.ly/10EeUtF",
		       "Ori_11": "http://bit.ly/18G71uf",
		       "Ori_12": "http://bit.ly/13n6Ql3"};

    var pa2sprite = { "Pa_63": {"x" : "-125px", "y" : "-20px"},
	  	      "Pa_60": {"x" : "-125px", "y" : "-55px"},
	  	      "Pa_35": {"x" : "-100px", "y" : "-85px"},
	  	      "Pa_38": {"x" : "-150px", "y" : "-55px"},
	  	      "Pa_32": {"x" : "-125px", "y" : "-105px"},
	  	      "Pa_6":  {"x" : "-125px", "y" : "-135px"},
	  	      "Pa_57": {"x" : "-125px", "y" : "-150px"},
	  	      "Pa_56": {"x" : "-125px", "y" : "-175px"},
	  	      "Pa_9R": {"x" : "-95px", "y" : "-125px"},
	  	      "Pa_9L": {"x" : "-160px", "y" : "-125px"},
	  	      "Pa_50": {"x" : "-70px", "y" : "-95px"},
	  	      "Pa_53": {"x" : "-180px", "y" : "-95px"},
	  	      "Pa_41": {"x" : "-125px", "y" : "-220px"},
	  	      "Pa_44": {"x" : "-30px", "y" : "-220px"},
	  	      "Pa_47": {"x" : "-220px", "y" : "-220px"},
	  	      "Pa_12": {"x" : "-125px", "y" : "-285px"},
	  	      "Pa_15": {"x" : "-65px", "y" : "-285px"},
	  	      "Pa_18": {"x" : "-190px", "y" : "-285px"},
	  	      "Pa_21": {"x" : "-125px", "y" : "-370px"},
	  	      "Pa_66": {"x" : "-125px", "y" : "-440px"},
	  	      "Pa_24": {"x" : "-55px", "y" : "-440px"},
	  	      "Pa_27": {"x" : "-195px", "y" : "-440px"}};

    var dist2sprite = { "0": {"x" : "-55px", "y" : "-190px"},
	  	      "1": {"x" : "-135px", "y" : "-190px"},
	  	      "2": {"x" : "-230px", "y" : "-190px"}};


    var exp2sprite = {}

    var exp_facial = { "group_1" : { "Exp_1" : "Bico", 
                                     "Exp_2" : "Bochechas infladas", 
                                     "Exp_3" : "Bochechas contraídas",
                                     "Exp_4" : "Lábios contraídos",
                                     "Exp_5" : "Olhos para a direita",
                                     "Exp_6" : "Olhos para a esquerda" },
                       "group_2" : { "Exp_7" : "Língua para baixo",
                                     "Exp_8" : "Língua reta",
				     "Exp_9" : "Neutra",
                                     "Exp_10" : "Olhos arregalados",
                                     "Exp_11" : "Sobrancelhas levantadas",
                                     "Exp_12" : "Sobrancelhas franzidas"  },
                       "group_3" : { "Exp_13" : "Bochecha direita inflada",
                                     "Exp_14" : "Susto",
                                     "Exp_15" : "Triste",
                                     "Exp_16" : "Raiva",
                                     "Exp_17" : "Desconfiado" } 
                     };
 
    var current_exp_group;
    var current_handshape_group;
    var parametros = {right : {}, left : {}};
    var state = "CONF_MAO";
    var isRightHand = true;
    var mao2sprite = {};

    var grupo = new Object();
    grupo['group_1'] = new Array("mao_14", "mao_12", "mao_13", "mao_16",
                                 "mao_48", "mao_33", "mao_34", "mao_47",
                                 "mao_36", "mao_21", "mao_23", "mao_24", "mao_31", "mao_35", "mao_37", "mao_49",
                                 "mao_54", "mao_8", "mao_52",
                                 "mao_60", "mao_25", "mao_53", "mao_55", "mao_56", "mao_57", "mao_59",
                                 "mao_26", "mao_27", "mao_29", "mao_30" );

    grupo['group_2'] = new Array("mao_28", "mao_22", "mao_58",
                                 "mao_50", "mao_3", "mao_4", "mao_5", "mao_6", "mao_39", "mao_40", "mao_51",
                                 "mao_42", "mao_41",
                                 "mao_44", "mao_43", "mao_45", "mao_46",
                                 "mao_38", "mao_9", "mao_15", "mao_17", "mao_18", "mao_19", "mao_20", "mao_32",
                                 "mao_2", "mao_1", "mao_7", "mao_10", "mao_11");

    // Modifica o background dos li DOM da section expressao_facial
    function set_button_bg( group ) {
      var nth_li;
      var exp_num;
      var exp_num_x;
      var exp_num_y;
    
      if( group == "prev" ){
          current_exp_group = "group_" + ( parseInt( current_exp_group.split("_")[1] ) - 1 );
          group = current_exp_group;
      }else if( group == "next" ){
          current_exp_group = "group_" + ( parseInt( current_exp_group.split("_")[1] ) + 1 );
          group = current_exp_group;
      }else{
          current_exp_group = group;
      }
   
      set_pagination();
    
      for( var key in exp_facial[group] ) {
        exp_num = parseInt( key.split("_")[1]  );
      
        if (( exp_num % 6 ) == 0 ) {
          nth_li = ":nth-child(" + 6  + ")";
          exp_num_x = '-' + ( 5 * 133 ) + 'px';
          exp_num_y = '-' + Math.floor( ( exp_num / 6 ) - 1 ) * 135 + 'px';
        } else {
          nth_li = ":nth-child(" +  (exp_num % 6)  + ")";
          exp_num_x = '-' + ( ( exp_num % 6 ) - 1 ) * 133 + 'px';
          exp_num_y = '-' + Math.floor( ( exp_num / 6 ) ) * 135 + 'px' ;
        }

	exp2sprite[key] = {"x": exp_num_x, "y": exp_num_y};
        $("#expressao_facial").find("li").filter(nth_li).css({'background-position': exp_num_x + " " + exp_num_y});
        $("#expressao_facial").find("li").filter(nth_li).attr("title", exp_facial[group][key]);
        $("#expressao_facial").find("li").filter(nth_li).data("exp_facial", key);
      } // Fim do for
    } // Fim da funcao set_button_bg  
    
    // Modifica a aparencia do pagination 
    function set_pagination() {
    
      if( current_exp_group == "group_1" ){
          $('.expressao_pagination').find("li").first().addClass("disabled");
      }else{
          $('.expressao_pagination').find("li").first().removeClass("disabled");
      }
    
      if( current_exp_group == "group_3" ){
          $('.expressao_pagination').find("li").last().addClass("disabled");
      }else{
          $('.expressao_pagination').find("li").last().removeClass("disabled");
      }

    } // Fim da funcao set_pagination
    
    // An expressao_pagination button is clicked 
    $('.expressao_pagination').on( 'click', 'li', function(event){
      event.preventDefault();
      if ( ( $(this).data("exp_group") == "prev" ) && ( current_exp_group != "group_1" ) ){
        set_button_bg( $(this).data("exp_group") );
      }else if ( ( $(this).data("exp_group") == "next" ) && ( current_exp_group != "group_3" ) ){
        set_button_bg( $(this).data("exp_group") );
      }
    
      if ( ( $(this).data("exp_group") != "prev" )  && ( $(this).data("exp_group") != "next" ) ){
        set_button_bg( $(this).data("exp_group") );
      }
    
    });
    
    // A handshape_pagination button is clicked 
    $('.handshape_pagination').on( 'click', 'li', function(event){
      event.preventDefault();
      if ( ( $(this).data("handshape_group") == "prev" ) && ( current_handshape_group != "group_1" ) ){
        formasDeMaoLiBg( $(this).data("handshape_group") );
      }else if ( ( $(this).data("handshape_group") == "next" ) && ( current_handshape_group != "group_2" ) ){
        formasDeMaoLiBg( $(this).data("handshape_group") );
      }
    
      if ( ( $(this).data("handshape_group") != "prev" )  && ( $(this).data("handshape_group") != "next" ) ){
        formasDeMaoLiBg( $(this).data("handshape_group") );
      }
    });
    
    // Modifica a aparencia do pagination 
    function set_handshape_pagination() {
    
      if( current_handshape_group == "group_1" ){
          $('.handshape_pagination').find("li").first().addClass("disabled");
      }else{
          $('.handshape_pagination').find("li").first().removeClass("disabled");
      }
    
      if( current_handshape_group == "group_2" ){
          $('.handshape_pagination').find("li").last().addClass("disabled");
      }else{
          $('.handshape_pagination').find("li").last().removeClass("disabled");
      }
    }

    // Modifica o background dos li DOM da section formas_de_mao
    function formasDeMaoLiBg(hand_group) {
      $("#tipos_de_mao").find('li').hide();
      
      if( hand_group == "prev" ) {
          current_handshape_group = "group_" + ( parseInt( current_handshape_group.split("_")[1] ) - 1 );
          hand_group = current_handshape_group;
      }else if ( hand_group == "next" ) {
          current_handshape_group = "group_" + ( parseInt( current_handshape_group.split("_")[1] ) + 1 );
          hand_group = current_handshape_group;
      } else {
          current_handshape_group = hand_group;
      }

      set_handshape_pagination();

      for( var i = 0; i < grupo[hand_group].length; i++) {
          var nth_li = ":nth-child(" + (i+1) + ")";
          var mao_num = parseInt( grupo[hand_group][i].split("_")[1] );
          var mao_num_x;
          var mao_num_y;
      
          if( ( mao_num % 10 ) == 0 ) { // Ultima imagem da linha do sprite
            mao_num_x = '-' + 9 * 65 + 'px'; 
            mao_num_y = '-' + Math.floor( ( mao_num / 10 ) - 1 ) * 80 + 'px';
          }else{
            mao_num_x = '-' + ( ( mao_num % 10 ) - 1 ) * 65 + 'px';
            mao_num_y = '-' + Math.floor( ( mao_num / 10 ) ) * 80 + 'px';
          }
      
	  confMao = 'conf_' + mao_num;
	  mao2sprite[confMao] = {x: mao_num_x, y: mao_num_y};
	  $("#tipos_de_mao").find("li").filter(nth_li).data('handshape', confMao);
          $("#tipos_de_mao").find("li").filter(nth_li).css({'background-position' : mao_num_x + " " + mao_num_y });
          $("#tipos_de_mao").find("li").filter(nth_li).fadeIn();
          $("#tipos_de_mao").find('li').last().fadeIn();
      } // Fim do for
    } // Fim da funcao formasDeMaoLiBg

    function mostrarPergunta() {
      $('#quantidade_maos').hide();
      $('#orientacao_palma_da_mao').hide();
      $('#expressao_facial').hide();
      $('#ponto_de_articulacao').hide();
      $('#tipos_de_mao').hide();
      $("#expressao_facial").hide();
      $('#report-pane').hide();
      $('#avatar_video').hide();
      $('#confirmacao_avatar').hide();
      $("#correcao").hide();
	
      var pergunta;
        
      if (state == "ORIENT_PALMA"){
	if (isRightHand){
		pergunta = "Escolha a orienta&ccedil;&atilde;o da m&atilde;o direita.";
	} else {
		pergunta = "Escolha a orienta&ccedil;&atilde;o da m&atilde;o esquerda.";
	}
        $('#orientacao_palma_da_mao').show();
      }
      else if (state == "EXP_FACIAL") {
	pergunta = "Com que express&atilde;o facial se faz o sinal?";
        set_button_bg("group_1");  
        $('#expressao_facial').show();
      }
      else if (state == "PONTO_ARTIC") {
	if (isRightHand) {
		pergunta = "A m&atilde;o direita fica suspensa em que ponto?";
	} else {
		pergunta = "A m&atilde;o esquerda fica suspensa em que ponto?";
	}
        $('#ponto_de_articulacao').show();
        $("#avatar_completo_img").show();
      }
      else if (state == "CONF_MAO") {
	if (isRightHand) {
		 pergunta = "Escolha a forma da m&atilde;o direita.";
	} else {
		pergunta = "Escolha a forma da m&atilde;o esquerda.";
	}

	formasDeMaoLiBg('group_1')
        $('#tipos_de_mao').show();
      }
      else if (state == "QTD_MAOS") {
	pergunta = "Com quantas m&atilde;os se faz o sinal?"
        $('#quantidade_maos').show();
      }
      else if (state == "DIST_MAOS") {
	if (isRightHand) {
		 pergunta = "A que dist&acirc;ncia do corpo a m&atilde;o direita faz o sinal?";
	} else {
		pergunta = "A que dist&acirc;ncia do corpo a m&atilde;o esquerda faz o sinal?";
	}

        $('#ponto_de_articulacao').show();
      }
      else if (state == "RENDER") {
	pergunta = "O avatar renderizado est&aacute; correto?";
	renderizarVideo();
        $("#report-pane").show();
      }
      else if (state == "CONFIRM_AVATAR") {
	$("#report-pane").show();
      }
      else if (state == "CORRECAO") {
	pergunta = "Clique na parte do sinal que precisa ser corrigida."
	showCorrecaoDiv();
      }
      $("#question").html( pergunta );
    } // Fim da funcao mostrarPergunta


    function showCorrecaoDiv() {
	$("#parametros_dir").html(getParametrosMaoHtml(true));
	$("#parametros_esq").html(getParametrosMaoHtml(false));

	configureCorrecaoDiv();

	expFacial = exp2sprite[parametros["EXP_FACIAL"]];
	$("#parametro_exp_facial").html("<h1>Express&atilde;o Facial</h1>"
				+ "<li class='exp_facial' style='background-position: " + expFacial.x  + " " + expFacial.y + ";'></li>");
	$("#correcao").show();
    }

    function configureCorrecaoDiv() {
	if (parametros["QTD_MAOS"] == "duas") {
		$("#remover_mao").show();
		$("#adicionar_mao").hide();
		$("#parametros_esq").show();
	} else {
		$("#remover_mao").hide();
		$("#adicionar_mao").show();
		$("#parametros_esq").hide();
	}
    }

    function getParametrosMaoHtml(rightHand) {
	
	var mao;
	if (rightHand || parametros["QTD_MAOS"] == "uma") {
		mao = parametros.right;
	} else {
		mao = parametros.left;
	}

	confMao = mao2sprite[mao["CONF_MAO"]];
	orientMao = orient2sprite[mao["ORIENT_PALMA"]];
	paSinal = pa2sprite[mao["PONTO_ARTIC"]];
	distMao = dist2sprite[mao["DIST_MAOS"]];

	return "<li class='handshape' style='background-position: "
			        + confMao.x  + " " + confMao.y + ";'></li>"
				+ "<li class='orient_mao'> <img src='" + orientMao + "'></li>"
				+ "<li class='ponto_articulacao' style='background-position: " + paSinal.x  + " " + paSinal.y + ";'></li>"
				+ "<li class='distancia' style='background-position: " + distMao.x  + " " + distMao.y + ";'></li></div>";
    }

    function saveAnswer(answer) {

	if (state == "CONFIRM_AVATAR" || state == "CORRECAO") {
		return;
	}

	if (state == "RENDER") {
		parametros.avatar_video = answer;
		return;
	}

	if (state == "EXP_FACIAL" || state == "QTD_MAOS") {
		parametros[state] = answer;
		return;
	}

	if (isRightHand) {
		parametros.right[state] = answer;
	} else {
		parametros.left[state] = answer;
	}	
    }

    function updateState(answer) {
	
	var nextState = "";

	if (state == "CONF_MAO") {
	     nextState = "ORIENT_PALMA";
	} else if (state == "CONF_MAO") {
	     nextState = "ORIENT_PALMA";
	} else if (state == "ORIENT_PALMA") {
	     nextState = "PONTO_ARTIC";
	} else if (state == "PONTO_ARTIC") {
	     nextState = "DIST_MAOS";
	} else if (state == "DIST_MAOS"){
	     if (isRightHand) {
		nextState = "QTD_MAOS";
	     } else {
		nextState = "EXP_FACIAL";
	     }
	} else if (state == "QTD_MAOS") {
	     if (answer == "uma") {
		nextState = "EXP_FACIAL";
	     } else {
		nextState = "CONF_MAO";
		isRightHand = false;
             }
	} else if (state == "EXP_FACIAL") {
		nextState = "RENDER";
	} else if (state == "RENDER") {
		nextState = "CONFIRM_AVATAR";
	} else if (state == "CONFIRM_AVATAR") {
	     if (answer == "Sim") {
		nextState = "TASK_END";
	     } else {
		nextState = "CORRECAO";
	     }
	} else if (state == "CORRECAO") {
	     nextState = "RENDER";
	}

	state = nextState;
	console.log(state);
     }

    function updatePA(rightHand) {
	var mao = rightHand ? parametros.right : parametros.left;
	paId = mao["PONTO_ARTIC"];

	if (paId == "Pa_9R" || paId == "Pa_9L") {
		paId = "Pa_9";
	}

        paId = "Pa_" + (parseInt(paId.split('_')[1]) + parseInt(mao["DIST_MAOS"]));
	mao["PONTO_ARTIC"] = paId;
    }	

    function preparaParametros() {
        parametros.final_state = "completed";

	if (parametros["QTD_MAOS"] == "duas") {
		updatePA(false);
	}
	updatePA(true);
    }

    function stopAndPlaySignalVideo (toPlay) {
	autoplay_Id = toPlay ? 1 : 0;
        $('#signal_video').html(function(){
            var video_id = task.info.video_id;
            return '<iframe type="text/html" width="540" height="450" src="http://www.youtube.com/embed/' + 
            video_id + '?autoplay=' + autoplay_Id + '&version=3&loop=1&playlist=' + video_id + '" />'});
    }

    function showRenderedVideo(video) {
	stopAndPlaySignalVideo(true);
        $('#avatar_video').html('<video width="395" height="400" controls="true" autoplay="autoplay" loop="true"> <source src=/libras-videos/' + video + '> </video>');
	$('#avatar_video').show();
	$('#confirmacao_avatar').show();
    }

    var tid;
    var progress_width;
    function updateRenderProgressBar(width) {
	progress_width = width
        $('#render_progress').html(function(){
	      return '<div class="bar" style="width: ' + width + '%"></div>'});
    }

    function updateRenderProgress() {
	if (progress_width < 100) {
		progress_width += 7;
		updateRenderProgressBar(progress_width);
	}
    }

    function stopRenderProgress() {
	updateRenderProgressBar(100);
	clearInterval(tid);
	$('#render_progress').fadeOut(1000);
    }

    function showRenderProgress() {
	updateRenderProgressBar(0);
	tid = setInterval(updateRenderProgress, 1000);
	$("#render_progress").show();
    }

    function renderizarVideo() {
        console.log(parametros);
	console.log(parametros.right);
	console.log(parametros.left);

	showRenderProgress();
        stopAndPlaySignalVideo(false);

	jQuery.ajax({
 	  type: 'POST',
	  url:    '/render',
	  contentType: 'application/json',
	  data: JSON.stringify(parametros),
	  success: function(result) {
	    video = result.rendered_video;
	    saveAnswer(video);
	    updateState(video);
	    mostrarPergunta();

	    stopRenderProgress();
	    showRenderedVideo(video);
	  },
	  error: function(result) {
	    alert("Error!");
	  },
	  async: true
	});

    } // Fim da funcao renderizarVideo

    if ( !$.isEmptyObject(task) ) {
      
        stopAndPlaySignalVideo(true);
        
        $('#task-id').html(task.id);
	parametros['signal_name'] = task.info.signal_name;
 	
        mostrarPergunta(state);
        
        $('.btn-answer').off('click').on('click', function(){
            var answer = $(this).attr('value');
            if( typeof answer != 'undefined' ){

              saveAnswer(answer);
              updateState(answer);	
              mostrarPergunta(state);

	      if (state == "TASK_END") {
		    preparaParametros();
		    pybossa.saveTask(task.id, parametros).done(function() {
      	              deferred.resolve(); 
                    });
	      } 
            } else{
              $("#error").show();
            }
        });
         
	// Evento de clique em pular tarefa
        $('.btn-warning').off('click').on('click', function(){
            var answer = $(this).attr('value');
            if( typeof answer != 'undefined' ){
	      if (answer == "Pular") {
		    parametros.final_state = "skipped";
		    pybossa.saveTask(task.id, parametros).done(function() {
      	              deferred.resolve(); 
                    });
	      }
            } else {
              $("#error").show();
            }
        });

	 // Eventos de cliques em pontos de articulação
         $("#avatar_completo").find("area").off('click').on('click', function(event){
           event.preventDefault();         
           answer = $(this).data('local');    
           saveAnswer(answer);      
 	   updateState(answer);
	   mostrarPergunta();

           $("#avatar_completo_img").hide();
           $("#avatar_distancia_img").fadeIn();
         });

         $("#avatar_distancia").find("area").off('click').on('click', function(event){
           event.preventDefault();
           $("#avatar_distancia_img").hide();
	   answer = $(this).data('local');
	   
 	   saveAnswer(answer); 
	   updateState(answer);
	   mostrarPergunta();
         });

	// Eventos de cliques em tipos de mão
         $(".handshape").off("click").on( "click", function() {
	   answer = $(this).data('handshape');
  	   saveAnswer(answer); 
	   updateState(answer);
	   mostrarPergunta();	
         });

         // Eventos de cliques em expressao facial
         var exp_answer;
         $('.exp').off('click').on( 'click', function(){
           exp_answer = $(this).data('exp_facial');
           saveAnswer(exp_answer);
           updateState(exp_answer);
           mostrarPergunta();
         });

        // Eventos de cliques no botão adicionar/remover mao da correção
        $('.add-remove').off('click').on('click', function(){
            var add_remove = $(this).attr('value');
	    if (add_remove == "Adicionar") {
		parametros.left = parametros.right;
		parametros["QTD_MAOS"] = "duas";
	    } else {
		parametros.left = {};
		parametros["QTD_MAOS"] = "uma";
	    }
	    configureCorrecaoDiv();
        });
    }
    else {
        $(".skeleton").hide();
        $("#finish").fadeIn(500);
    } 
});

pybossa.setEndpoint('/pybossa');
pybossa.run('librasdictionary');

</script>

<style type="text/css">

  div#parametros_sinal li.handshape {
    margin: 1px 0 0 1px;
    float: left;
    width: 65px;
    height: 80px;
    display: inline;
    list-style: none;
    background: url("http://imageshack.us/a/img5/1439/spritehandsshape.png") no-repeat;
  }

  section#tipos_de_mao li.handshape:hover {
    -webkit-box-shadow: inset 0 0 10px #F70;
    -moz-box-shadow: inset 0 0 10px #F70;
    box-shadow: inset 0 0 10px #F70;
  }

  #tipos_de_mao li:last-child {
    background: #FFF;
  }
 
  section#expressao_facial {
    /*padding: 0;*/
  }
  
  section#expressao_facial li.exp {
    float: left;
    list-style: none;
    width: 133px;
    height: 133px;
    margin: 6px 0 0 5px;
    background: url("http://imageshack.us/a/img850/2828/l19.png") no-repeat;
    position: relative;
  }
  
  section#expressao_facial li.exp:hover {
    -webkit-box-shadow: inset 0 0 10px #F70;
    -moz-box-shadow: inset 0 0 10px #F70;
    box-shadow: inset 0 0 10px #F70;
  }

  div#correcao li.orient_mao {
    margin: 1px 0 0 1px;
    float: left;
    width: 61px;
    height: 80px;
    display: inline;
    list-style: none;
  }

  div#correcao li.ponto_articulacao {
    margin: 1px 0 0 1px;
    float: left;
    width: 65px;
    height: 80px;
    display: inline;
    list-style: none;
    background: url("http://img824.imageshack.us/img824/3774/gb5u.png") no-repeat;
  }

  div#correcao li.distancia {
    margin: 1px 0 0 1px;
    float: left;
    width: 65px;
    height: 80px;
    display: inline;
    list-style: none;
    background: url("http://bit.ly/10Y64tS") no-repeat;
  }

  div#correcao li.exp_facial {
    float: left;
    list-style: none;
    width: 133px;
    height: 133px;
    background: url("http://imageshack.us/a/img850/2828/l19.png") no-repeat;
    position: relative;
  }
</style>
